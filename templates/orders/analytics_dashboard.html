{% extends 'base.html' %}
{% load i18n %}

{% block title %}{% trans "–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –æ—Ç—á–µ—Ç—ã" %} - XXL OrderHub{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>üìä {% trans "–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –æ—Ç—á–µ—Ç—ã" %}</h2>
            <div>
                <a href="{% url 'analytics_export' %}?type=overview&date_from={{ date_range.from }}&date_to={{ date_range.to }}" 
                   class="btn btn-outline-success btn-sm me-2">
                    üìÑ {% trans "–≠–∫—Å–ø–æ—Ä—Ç –≤ Excel" %}
                </a>
                <a href="{% url 'order_list' %}" class="btn btn-outline-primary btn-sm">
                    üìã {% trans "–ö –∑–∞–∫–∞–∑–∞–º" %}
                </a>
            </div>
        </div>

        <!-- –§–∏–ª—å—Ç—Ä—ã -->
        <div class="card mb-4">
            <div class="card-body">
                <form method="get" class="row g-3">
                    <div class="col-md-4">
                        <label for="date_from" class="form-label">{% trans "–î–∞—Ç–∞ —Å" %}</label>
                        <input type="date" class="form-control" id="date_from" name="date_from" 
                               value="{{ date_range.from }}">
                    </div>
                    <div class="col-md-4">
                        <label for="date_to" class="form-label">{% trans "–î–∞—Ç–∞ –ø–æ" %}</label>
                        <input type="date" class="form-control" id="date_to" name="date_to" 
                               value="{{ date_range.to }}">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">&nbsp;</label>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">{% trans "–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä" %}</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- KPI –º–µ—Ç—Ä–∏–∫–∏ -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title text-primary">{{ kpi_metrics.total_orders }}</h5>
                        <p class="card-text">{% trans "–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤" %}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title text-success">{{ kpi_metrics.completion_rate }}%</h5>
                        <p class="card-text">{% trans "–ó–∞–≤–µ—Ä—à–µ–Ω–æ" %}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title text-info">{{ kpi_metrics.invoice_rate }}%</h5>
                        <p class="card-text">{% trans "–° –∏–Ω–≤–æ–π—Å–∞–º–∏" %}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title text-warning">{{ kpi_metrics.avg_processing_time }}</h5>
                        <p class="card-text">{% trans "–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è (–¥–Ω–∏)" %}</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">{% trans "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º" %}</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="statusChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>

            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ñ–∞–±—Ä–∏–∫–∞–º -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">{% trans "–¢–æ–ø —Ñ–∞–±—Ä–∏–∫ –ø–æ –∑–∞–∫–∞–∑–∞–º" %}</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="factoryChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä—è–¥—ã -->
            <div class="col-md-8 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">{% trans "–î–∏–Ω–∞–º–∏–∫–∞ –∑–∞–∫–∞–∑–æ–≤" %}</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="timeSeriesChart" width="600" height="300"></canvas>
                    </div>
                </div>
            </div>

            <!-- –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã -->
            <div class="col-md-4 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">{% trans "–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã" %}</h5>
                    </div>
                    <div class="card-body">
                        {% if overdue_orders %}
                        <div class="list-group">
                            {% for order in overdue_orders|slice:":5" %}
                            <a href="{% url 'order_detail' order.pk %}" class="list-group-item list-group-item-action">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">{{ order.title|truncatechars:20 }}</h6>
                                    <small>{% if order.days_since_upload %}{{ order.days_since_upload }}{% else %}{{ order.days_since_sent|default:"0" }}{% endif %} {% trans "–¥–Ω–µ–π" %}</small>
                                </div>
                                <p class="mb-1">{{ order.factory.name }}</p>
                                <small class="text-warning">‚ö†Ô∏è {% trans "–¢—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è" %}</small>
                            </a>
                            {% endfor %}
                        </div>
                        {% if overdue_orders|length > 5 %}
                        <div class="text-center mt-2">
                            <small class="text-muted">{% trans "–ò –µ—â–µ" %} {{ overdue_orders|length|add:"-5" }} {% trans "–∑–∞–∫–∞–∑–æ–≤" %}</small>
                        </div>
                        {% endif %}
                        {% else %}
                        <div class="text-center text-muted">
                            <i class="fas fa-check-circle fa-3x mb-3"></i>
                            <p>{% trans "–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ –Ω–µ—Ç" %}</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="row">
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">{% trans "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ñ–∞–±—Ä–∏–∫–∞–º" %}</h5>
                    </div>
                    <div class="card-body">
                        {% if factory_stats %}
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>{% trans "–§–∞–±—Ä–∏–∫–∞" %}</th>
                                        <th>{% trans "–ó–∞–∫–∞–∑—ã" %}</th>
                                        <th>{% trans "–ó–∞–≤–µ—Ä—à–µ–Ω–æ" %}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for factory in factory_stats|slice:":10" %}
                                    <tr>
                                        <td>
                                            <strong>{{ factory.factory__name }}</strong><br>
                                            <small class="text-muted">{{ factory.factory__country__name }}</small>
                                        </td>
                                        <td>{{ factory.total_orders }}</td>
                                        <td>
                                            <span class="badge bg-success">{{ factory.completed_orders }}</span>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center text-muted">
                            <p>{% trans "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥" %}</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">{% trans "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å—Ç—Ä–∞–Ω–∞–º" %}</h5>
                    </div>
                    <div class="card-body">
                        {% if country_stats %}
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>{% trans "–°—Ç—Ä–∞–Ω–∞" %}</th>
                                        <th>{% trans "–ó–∞–∫–∞–∑—ã" %}</th>
                                        <th>{% trans "–§–∞–±—Ä–∏–∫–∏" %}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for country in country_stats %}
                                    <tr>
                                        <td><strong>{{ country.factory__country__name }}</strong></td>
                                        <td>{{ country.total_orders }}</td>
                                        <td>{{ country.total_factories }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center text-muted">
                            <p>{% trans "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥" %}</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// –î–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
const statusData = {
    labels: ['{% trans "–ó–∞–≥—Ä—É–∂–µ–Ω–æ" %}', '{% trans "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ" %}', '{% trans "–ò–Ω–≤–æ–π—Å –ø–æ–ª—É—á–µ–Ω" %}', '{% trans "–ó–∞–≤–µ—Ä—à–µ–Ω–æ" %}', '{% trans "–û—Ç–º–µ–Ω–µ–Ω–æ" %}'],
    datasets: [{
        data: [{{ overview.uploaded }}, {{ overview.sent }}, {{ overview.invoice_received }}, {{ overview.completed }}, {{ overview.cancelled }}],
        backgroundColor: ['#ffc107', '#17a2b8', '#28a745', '#6f42c1', '#dc3545'],
        borderWidth: 1
    }]
};

const factoryData = {
    labels: [
        {% for factory in factory_stats|slice:":5" %}
        '{{ factory.factory__name|truncatechars:15 }}',
        {% endfor %}
    ],
    datasets: [{
        label: '{% trans "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤" %}',
        data: [
            {% for factory in factory_stats|slice:":5" %}
            {{ factory.total_orders }},
            {% endfor %}
        ],
        backgroundColor: '#007bff',
        borderColor: '#0056b3',
        borderWidth: 1
    }]
};

// –ì—Ä–∞—Ñ–∏–∫ —Å—Ç–∞—Ç—É—Å–æ–≤
const statusCtx = document.getElementById('statusChart').getContext('2d');
new Chart(statusCtx, {
    type: 'doughnut',
    data: statusData,
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

// –ì—Ä–∞—Ñ–∏–∫ —Ñ–∞–±—Ä–∏–∫
const factoryCtx = document.getElementById('factoryChart').getContext('2d');
new Chart(factoryCtx, {
    type: 'bar',
    data: factoryData,
    options: {
        responsive: true,
        scales: {
            y: {
                beginAtZero: true
            }
        },
        plugins: {
            legend: {
                display: false
            }
        }
    }
});

// –ì—Ä–∞—Ñ–∏–∫ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä—è–¥–æ–≤
const timeSeriesCtx = document.getElementById('timeSeriesChart').getContext('2d');
new Chart(timeSeriesCtx, {
    type: 'line',
    data: {
        labels: [
            {% for item in time_series %}
            '{{ item.period|date:"d.m" }}',
            {% endfor %}
        ],
        datasets: [{
            label: '{% trans "–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤" %}',
            data: [
                {% for item in time_series %}
                {{ item.total_orders }},
                {% endfor %}
            ],
            borderColor: '#007bff',
            backgroundColor: 'rgba(0, 123, 255, 0.1)',
            tension: 0.1
        }, {
            label: '{% trans "–ó–∞–≤–µ—Ä—à–µ–Ω–æ" %}',
            data: [
                {% for item in time_series %}
                {{ item.completed_orders }},
                {% endfor %}
            ],
            borderColor: '#28a745',
            backgroundColor: 'rgba(40, 167, 69, 0.1)',
            tension: 0.1
        }]
    },
    options: {
        responsive: true,
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});
</script>
{% endblock %}
