{% extends 'base.html' %}
{% load i18n %}
{% load file_utils %}

{% block title %}{{ basket.name }} - XXL OrderHub{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'home' %}">{% trans "–ì–ª–∞–≤–Ω–∞—è" %}</a></li>
                <li class="breadcrumb-item"><a href="{% url 'efactura_basket_list' %}">{% trans "–ö–æ—Ä–∑–∏–Ω—ã E-Factura" %}</a></li>
                <li class="breadcrumb-item active">{{ basket.name }}</li>
            </ol>
        </nav>

        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>{{ basket.name }}</h2>
            <div>
                <a href="{% url 'efactura_basket_list' %}" class="btn btn-outline-secondary">
                    ‚Üê {% trans "–ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É" %}
                </a>
                {% if files %}
                <a href="{% url 'download_all_efactura_files' basket_id=basket.pk %}" class="btn btn-success">
                    üì¶ {% trans "–°–∫–∞—á–∞—Ç—å –≤—Å–µ —Ñ–∞–π–ª—ã" %}
                </a>
                {% endif %}
            </div>
        </div>

        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ—Ä–∑–∏–Ω–µ -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">{% trans "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ—Ä–∑–∏–Ω–µ" %}</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>{% trans "–ù–∞–∑–≤–∞–Ω–∏–µ:" %}</strong> {{ basket.name }}</p>
                        <p><strong>{% trans "–ì–æ–¥:" %}</strong> {{ basket.year }}</p>
                        <p><strong>{% trans "–ú–µ—Å—è—Ü:" %}</strong> 
                            {% if basket.month == 1 %}{% trans "–Ø–Ω–≤–∞—Ä—å" %}
                            {% elif basket.month == 2 %}{% trans "–§–µ–≤—Ä–∞–ª—å" %}
                            {% elif basket.month == 3 %}{% trans "–ú–∞—Ä—Ç" %}
                            {% elif basket.month == 4 %}{% trans "–ê–ø—Ä–µ–ª—å" %}
                            {% elif basket.month == 5 %}{% trans "–ú–∞–π" %}
                            {% elif basket.month == 6 %}{% trans "–ò—é–Ω—å" %}
                            {% elif basket.month == 7 %}{% trans "–ò—é–ª—å" %}
                            {% elif basket.month == 8 %}{% trans "–ê–≤–≥—É—Å—Ç" %}
                            {% elif basket.month == 9 %}{% trans "–°–µ–Ω—Ç—è–±—Ä—å" %}
                            {% elif basket.month == 10 %}{% trans "–û–∫—Ç—è–±—Ä—å" %}
                            {% elif basket.month == 11 %}{% trans "–ù–æ—è–±—Ä—å" %}
                            {% elif basket.month == 12 %}{% trans "–î–µ–∫–∞–±—Ä—å" %}
                            {% endif %}
                        </p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>{% trans "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤:" %}</strong> <span class="badge bg-info">{{ total_files }}</span></p>
                        <p><strong>{% trans "–î–∞—Ç–∞ –∫–æ—Ä–∑–∏–Ω—ã:" %}</strong> {{ basket.basket_date|date:"d.m.Y" }}</p>
                        <p><strong>{% trans "–°–æ–∑–¥–∞–Ω–∞:" %}</strong> 
                            {% if basket.created_by %}
                                {{ basket.created_by.username }}
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                            <br>
                            <small class="text-muted">{{ basket.created_at|date:"d.m.Y H:i" }}</small>
                        </p>
                    </div>
                </div>
                {% if basket.notes %}
                <div class="mt-3">
                    <strong>{% trans "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏:" %}</strong>
                    <p class="mt-2">{{ basket.notes|linebreaks }}</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- –§–æ—Ä–º–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">{% trans "–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª E-Factura" %}</h5>
            </div>
            <div class="card-body">
                <form method="post" action="{% url 'upload_efactura_file' basket.pk %}" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.order.id_for_label }}" class="form-label">{{ form.order.label }}</label>
                            {{ form.order }}
                            {% if form.order.errors %}
                            <div class="text-danger small">{{ form.order.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.upload_date.id_for_label }}" class="form-label">{{ form.upload_date.label }}</label>
                            {{ form.upload_date }}
                            {% if form.upload_date.errors %}
                            <div class="text-danger small">{{ form.upload_date.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="{{ form.file.id_for_label }}" class="form-label">{{ form.file.label }}</label>
                        {{ form.file }}
                        {% if form.file.errors %}
                        <div class="text-danger small">{{ form.file.errors }}</div>
                        {% endif %}
                        <small class="form-text text-muted">{% trans "–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: PDF, XML, XLSX, XLS" %}</small>
                    </div>
                    <div class="mb-3">
                        <label for="{{ form.notes.id_for_label }}" class="form-label">{{ form.notes.label }}</label>
                        {{ form.notes }}
                        {% if form.notes.errors %}
                        <div class="text-danger small">{{ form.notes.errors }}</div>
                        {% endif %}
                    </div>
                    <button type="submit" class="btn btn-primary">{% trans "–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª" %}</button>
                </form>
            </div>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">{% trans "–§–∞–π–ª—ã –≤ –∫–æ—Ä–∑–∏–Ω–µ" %}</h5>
            </div>
            <div class="card-body">
                {% if files %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>{% trans "–ó–∞–∫–∞–∑" %}</th>
                                <th>{% trans "–§–∞–±—Ä–∏–∫–∞" %}</th>
                                <th>{% trans "–§–∞–π–ª" %}</th>
                                <th>{% trans "–î–∞—Ç–∞ –∑–∞–≥—Ä—É–∑–∫–∏" %}</th>
                                <th>{% trans "–ó–∞–≥—Ä—É–∑–∏–ª" %}</th>
                                <th>{% trans "–î–µ–π—Å—Ç–≤–∏—è" %}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for file in files %}
                            <tr>
                                <td>
                                    <a href="{% url 'order_detail' file.order.pk %}">{{ file.order.title }}</a>
                                </td>
                                <td>
                                    {% if file.order.factory %}
                                        {{ file.order.factory.name }}
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if file.file %}
                                        {{ file.file|filename }}
                                        <br>
                                        <small class="text-muted">{{ file.file|filesize }}</small>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>{{ file.upload_date|date:"d.m.Y" }}</td>
                                <td>
                                    {% if file.created_by %}
                                        {{ file.created_by.username }}
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                    <br>
                                    <small class="text-muted">{{ file.created_at|date:"d.m.Y H:i" }}</small>
                                </td>
                                <td>
                                    {% if file.file %}
                                    <a href="{% url 'download_efactura_file' file.pk %}" class="btn btn-sm btn-outline-success">
                                        üìÑ {% trans "–°–∫–∞—á–∞—Ç—å" %}
                                    </a>
                                    {% endif %}
                                </td>
                            </tr>
                            {% if file.notes %}
                            <tr>
                                <td colspan="6" class="text-muted small">
                                    <strong>{% trans "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:" %}</strong> {{ file.notes }}
                                </td>
                            </tr>
                            {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info">
                    <p class="mb-0">{% trans "–í –∫–æ—Ä–∑–∏–Ω–µ –ø–æ–∫–∞ –Ω–µ—Ç —Ñ–∞–π–ª–æ–≤." %}</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

