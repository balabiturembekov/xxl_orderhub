{% extends 'base.html' %}
{% load i18n %}

{% block title %}{% trans "Создать заказ" %} - XXL OrderHub{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'home' %}">{% trans "Главная" %}</a></li>
                <li class="breadcrumb-item"><a href="{% url 'order_list' %}">{% trans "Заказы" %}</a></li>
                <li class="breadcrumb-item active">{% trans "Создать заказ" %}</li>
            </ol>
        </nav>

        <div class="card">
            <div class="card-header">
                <h3 class="mb-0">{% trans "Создать новый заказ" %}</h3>
            </div>
            <div class="card-body">
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    
                    {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {{ form.non_field_errors }}
                        </div>
                    {% endif %}

                    <div class="row">
                        <div class="col-md-12">
                            <div class="mb-3">
                                <label for="{{ form.title.id_for_label }}" class="form-label">
                                    {% trans "Название заказа" %} <span class="text-danger">*</span>
                                </label>
                                {{ form.title }}
                                {% if form.title.help_text %}
                                    <div class="form-text">{{ form.title.help_text }}</div>
                                {% endif %}
                                {% if form.title.errors %}
                                    <div class="text-danger">
                                        {% for error in form.title.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12">
                            <div class="mb-3">
                                <label for="{{ form.description.id_for_label }}" class="form-label">
                                    {% trans "Описание заказа" %}
                                </label>
                                {{ form.description }}
                                {% if form.description.help_text %}
                                    <div class="form-text">{{ form.description.help_text }}</div>
                                {% endif %}
                                {% if form.description.errors %}
                                    <div class="text-danger">
                                        {% for error in form.description.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12">
                            <div class="mb-3">
                                <label for="{{ form.factory.id_for_label }}" class="form-label">
                                    {% trans "Фабрика" %} <span class="text-danger">*</span>
                                </label>
                                <div class="input-group">
                                    {{ form.factory }}
                                    <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addFactoryModal">
                                        <i class="bi bi-plus-circle"></i> {% trans "Добавить фабрику" %}
                                    </button>
                                </div>
                                <div class="form-text mt-1">
                                    <i class="fas fa-info-circle"></i> {% trans "Начните вводить название фабрики для быстрого поиска. Фабрики сгруппированы по странам." %}
                                </div>
                                {% if form.factory.errors %}
                                    <div class="text-danger">
                                        {% for error in form.factory.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">
                                    {% trans "Выберите фабрику-исполнителя заказа. Excel файл будет отправлен на email выбранной фабрики." %}
                                    <a href="{% url 'factory_list' %}" target="_blank" class="ms-2">
                                        <i class="bi bi-gear"></i> {% trans "Управление фабриками" %}
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12">
                            <div class="mb-3">
                                <label for="{{ form.excel_file.id_for_label }}" class="form-label">
                                    {% trans "Excel файл заказа" %} <span class="text-danger">*</span>
                                </label>
                                {{ form.excel_file }}
                                {% if form.excel_file.errors %}
                                    <div class="text-danger">
                                        {% for error in form.excel_file.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">
                                    {% trans "Загрузите Excel файл с деталями заказа (.xlsx или .xls). Файл должен содержать спецификацию товаров, количество, цены и другие детали заказа." %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12">
                            <div class="mb-3">
                                <label for="{{ form.comments.id_for_label }}" class="form-label">
                                    {% trans "Дополнительная информация" %}
                                </label>
                                {{ form.comments }}
                                {% if form.comments.errors %}
                                    <div class="text-danger">
                                        {% for error in form.comments.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">
                                    {% trans "Дополнительные комментарии, заметки, особые требования к заказу. Это поле необязательно для заполнения." %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <a href="{% url 'order_list' %}" class="btn btn-outline-secondary me-md-2">
                                    {% trans "Отмена" %}
                                </a>
                                <button type="submit" class="btn btn-primary">
                                    {% trans "Создать заказ" %}
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Информация о процессе -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">{% trans "Что происходит после создания заказа?" %}</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="text-center">
                            <div class="mb-2">1️⃣</div>
                            <h6>{% trans "Заказ создан" %}</h6>
                            <p class="text-muted small">{% trans "Файл загружен, заказ готов к отправке" %}</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <div class="mb-2">2️⃣</div>
                            <h6>{% trans "Отправка на фабрику" %}</h6>
                            <p class="text-muted small">{% trans "Excel файл отправляется на email фабрики" %}</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <div class="mb-2">3️⃣</div>
                            <h6>{% trans "Получение инвойса" %}</h6>
                            <p class="text-muted small">{% trans "Фабрика присылает PDF инвойс, который вы загружаете в систему" %}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для добавления страны -->
<div class="modal fade" id="addCountryModal" tabindex="-1" aria-labelledby="addCountryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addCountryModalLabel">{% trans "Добавить страну" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="addCountryForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="country_name" class="form-label">{% trans "Название страны" %} *</label>
                        <input type="text" class="form-control" id="country_name" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="country_code" class="form-label">{% trans "Код страны" %} *</label>
                        <input type="text" class="form-control" id="country_code" name="code" maxlength="3" required>
                        <div class="form-text">{% trans "Например: RU, US, DE" %}</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Отмена" %}</button>
                    <button type="submit" class="btn btn-primary">{% trans "Добавить" %}</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Модальное окно для добавления фабрики -->
<div class="modal fade" id="addFactoryModal" tabindex="-1" aria-labelledby="addFactoryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addFactoryModalLabel">{% trans "Добавить фабрику" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="addFactoryForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="factory_name" class="form-label">{% trans "Название фабрики" %} *</label>
                                <input type="text" class="form-control" id="factory_name" name="name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="factory_country" class="form-label">{% trans "Страна" %} *</label>
                                <div class="input-group">
                                    <select class="form-select" id="factory_country" name="country" required>
                                        <option value="">{% trans "Выберите страну" %}</option>
                                    </select>
                                    <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#addCountryModal">
                                        <i class="bi bi-plus"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="factory_email" class="form-label">{% trans "Email для отправки заказов" %} *</label>
                        <input type="email" class="form-control" id="factory_email" name="email" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="factory_contact" class="form-label">{% trans "Контактное лицо" %}</label>
                                <input type="text" class="form-control" id="factory_contact" name="contact_person">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="factory_phone" class="form-label">{% trans "Телефон" %}</label>
                                <input type="text" class="form-control" id="factory_phone" name="phone">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="factory_address" class="form-label">{% trans "Адрес" %}</label>
                        <textarea class="form-control" id="factory_address" name="address" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="factory_active" name="is_active" checked>
                            <label class="form-check-label" for="factory_active">
                                {% trans "Фабрика активна" %}
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Отмена" %}</button>
                    <button type="submit" class="btn btn-primary">{% trans "Добавить" %}</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock content %}

{% block extra_css %}
<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
<style>
    /* Стили для Select2 */
    .select2-container--bootstrap-5 .select2-selection {
        min-height: 38px;
        border: 1px solid #ced4da;
    }
    .select2-container--bootstrap-5 .select2-selection--single .select2-selection__rendered {
        line-height: 36px;
    }
    .select2-container--bootstrap-5 .select2-selection--single .select2-selection__arrow {
        height: 36px;
    }
    .select2-results__option {
        padding: 8px 12px;
    }
    .select2-results__group {
        font-weight: 600;
        color: #495057;
        background-color: #f8f9fa;
        padding: 8px 12px;
    }
</style>
{% endblock extra_css %}

{% block extra_js %}
<!-- jQuery (required for Select2) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ BUG-36: Проверяем существование элементов перед добавлением обработчиков
    const addFactoryModal = document.getElementById('addFactoryModal');
    if (addFactoryModal) {
        addFactoryModal.addEventListener('show.bs.modal', function() {
            loadCountries();
        });
    }
    
    const addCountryForm = document.getElementById('addCountryForm');
    if (addCountryForm) {
        addCountryForm.addEventListener('submit', function(e) {
            e.preventDefault();
            addCountry();
        });
    }
    
    const addFactoryForm = document.getElementById('addFactoryForm');
    if (addFactoryForm) {
        addFactoryForm.addEventListener('submit', function(e) {
            e.preventDefault();
            addFactory();
        });
    }
    
    const addCountryModal = document.getElementById('addCountryModal');
    if (addCountryModal) {
        addCountryModal.addEventListener('hidden.bs.modal', function() {
            loadCountries();
        });
    }
});

function loadCountries() {
    fetch('{% url "get_countries" %}')
        .then(response => {
            // КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ BUG-35: Проверяем статус ответа перед парсингом JSON
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            // КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ BUG-36: Проверяем существование элемента
            const select = document.getElementById('factory_country');
            if (!select) {
                console.error('Country select element not found');
                return;
            }
            select.innerHTML = '<option value="">{% trans "Выберите страну" %}</option>';
            if (data.countries && Array.isArray(data.countries)) {
                data.countries.forEach(country => {
                    const option = document.createElement('option');
                    option.value = country.id;
                    option.textContent = country.name;
                    select.appendChild(option);
                });
            }
        })
        .catch(error => {
            // КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ BUG-33: Обработка ошибок загрузки стран
            console.error('Error loading countries:', error);
            if (typeof showAlert === 'function') {
                showAlert('Ошибка при загрузке списка стран. Пожалуйста, обновите страницу.', 'danger');
            } else {
                alert('Ошибка при загрузке списка стран. Пожалуйста, обновите страницу.');
            }
        });
}

function addCountry() {
    const form = document.getElementById('addCountryForm');
    if (!form) {
        showAlert('Форма не найдена', 'danger');
        return;
    }
    
    const formData = new FormData(form);
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (!csrfToken) {
        showAlert('Ошибка безопасности. Пожалуйста, обновите страницу.', 'danger');
        return;
    }
    
    fetch('{% url "create_country_ajax" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': csrfToken.value
        }
    })
    .then(response => {
        // КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ BUG-35: Проверяем статус ответа перед парсингом JSON
        if (!response.ok) {
            return response.json().then(err => {
                throw new Error(err.message || `HTTP error! status: ${response.status}`);
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Закрываем модальное окно
            const modal = bootstrap.Modal.getInstance(document.getElementById('addCountryModal'));
            if (modal) {
                modal.hide();
            }
            
            // Очищаем форму
            form.reset();
            
            // Показываем сообщение об успехе
            showAlert('Страна успешно добавлена!', 'success');
            
            // Обновляем список стран в модальном окне фабрики
            loadCountries();
        } else {
            const errorMessage = data.errors ? JSON.stringify(data.errors) : (data.message || 'Неизвестная ошибка');
            showAlert('Ошибка при добавлении страны: ' + errorMessage, 'danger');
        }
    })
    .catch(error => {
        // КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ BUG-40: Обработка сетевых ошибок
        console.error('Error adding country:', error);
        showAlert('Ошибка при добавлении страны: ' + error.message, 'danger');
    });
}

function addFactory() {
    const form = document.getElementById('addFactoryForm');
    if (!form) {
        showAlert('Форма не найдена', 'danger');
        return;
    }
    
    const formData = new FormData(form);
    
    // КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ: Клиентская валидация перед отправкой
    const name = formData.get('name')?.trim();
    const email = formData.get('email')?.trim();
    const country = formData.get('country');
    
    if (!name || !email || !country) {
        showAlert('Пожалуйста, заполните все обязательные поля', 'danger');
        return;
    }
    
    // Валидация email на клиенте
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
        showAlert('Пожалуйста, введите корректный email адрес', 'danger');
        return;
    }
    
    // КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ: Преобразуем FormData в JSON
    // и переименовываем поле 'country' в 'country_id'
    const data = {
        name: name,
        email: email,
        country_id: country,  // Переименовываем country в country_id
        contact_person: formData.get('contact_person')?.trim() || '',
        phone: formData.get('phone')?.trim() || '',
        address: formData.get('address')?.trim() || '',
        is_active: formData.get('is_active') === 'on'  // Преобразуем checkbox в boolean
    };
    
    // КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ: Проверка CSRF токена
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
    if (!csrfToken) {
        showAlert('Ошибка безопасности. Пожалуйста, обновите страницу.', 'danger');
        return;
    }
    
    fetch('{% url "create_factory_ajax" %}', {
        method: 'POST',
        body: JSON.stringify(data),
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => {
        // КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ BUG-35: Проверяем статус ответа перед парсингом JSON
        if (!response.ok) {
            return response.json().then(err => {
                throw new Error(err.message || `HTTP error! status: ${response.status}`);
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Закрываем модальное окно
            const modal = bootstrap.Modal.getInstance(document.getElementById('addFactoryModal'));
            if (modal) {
                modal.hide();
            }
            
            // Очищаем форму
            form.reset();
            
            // Показываем сообщение об успехе
            showAlert('Фабрика успешно добавлена!', 'success');
            
            // КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ: Обновляем список фабрик без перезагрузки страницы
            const countryName = (data.factory.country && data.factory.country.name) || 'Без страны';
            updateFactorySelect(data.factory.id, data.factory.name, countryName);
        } else {
            const errorMessage = data.message || data.errors || 'Неизвестная ошибка';
            showAlert('Ошибка при добавлении фабрики: ' + errorMessage, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Ошибка при добавлении фабрики: ' + error.message, 'danger');
    });
}

function updateFactorySelect(factoryId, factoryName, countryName) {
    // Обновляем select с фабриками, добавляя новую фабрику
    // КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ: Ищем select по классу или по имени поля
    // Используем более специфичный селектор для избежания конфликтов
    const factorySelect = document.querySelector('select[name="factory"]') || 
                          document.querySelector('#id_factory');
    
    if (factorySelect) {
        // Если используется Select2, вызываем глобальную функцию
        if (window.updateFactorySelect && typeof window.updateFactorySelect === 'function') {
            window.updateFactorySelect(factoryId, factoryName, countryName || 'Без страны');
            return;
        }
        
        // КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ: Проверяем, не существует ли уже такая фабрика
        const existingOption = factorySelect.querySelector(`option[value="${factoryId}"]`);
        if (existingOption) {
            // Фабрика уже есть в списке, просто выбираем её
            existingOption.selected = true;
            if (typeof jQuery !== 'undefined' && typeof jQuery.fn.select2 !== 'undefined') {
                jQuery(factorySelect).trigger('change');
            }
            return;
        }
        
        // Находим соответствующую группу или создаем новую
        let optgroup = null;
        const optgroups = factorySelect.querySelectorAll('optgroup');
        for (let i = 0; i < optgroups.length; i++) {
            if (optgroups[i].label === (countryName || 'Без страны')) {
                optgroup = optgroups[i];
                break;
            }
        }
        
        if (!optgroup) {
            optgroup = document.createElement('optgroup');
            optgroup.label = countryName || 'Без страны';
            factorySelect.appendChild(optgroup);
        }
        
        // Создаем новую опцию
        const option = document.createElement('option');
        option.value = factoryId;
        option.textContent = factoryName;
        option.setAttribute('data-country', countryName || 'Без страны');
        option.setAttribute('data-group', countryName || 'Без страны');
        option.selected = true;
        optgroup.appendChild(option);
        
        // Обновляем Select2 если он инициализирован
        if (typeof jQuery !== 'undefined' && typeof jQuery.fn.select2 !== 'undefined') {
            jQuery(factorySelect).trigger('change');
        }
    } else {
        // Если не нашли select, перезагружаем страницу
        console.warn('Factory select not found, reloading page');
        location.reload();
    }
}

function showAlert(message, type) {
    // КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ BUG-34: Используем безопасные методы вместо innerHTML для предотвращения XSS
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    
    // Безопасное добавление текста сообщения
    const messageText = document.createTextNode(message);
    alertDiv.appendChild(messageText);
    
    // Создаем кнопку закрытия безопасным способом
    const closeButton = document.createElement('button');
    closeButton.type = 'button';
    closeButton.className = 'btn-close';
    closeButton.setAttribute('data-bs-dismiss', 'alert');
    closeButton.setAttribute('aria-label', 'Close');
    alertDiv.appendChild(closeButton);
    
    // КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ: Безопасная вставка alert с проверкой существования элемента
    const content = document.querySelector('.main-content') || 
                   document.querySelector('.container') ||
                   document.querySelector('body');
    
    if (content) {
        // Вставляем alert в начало контента
        if (content.firstChild) {
            content.insertBefore(alertDiv, content.firstChild);
        } else {
            content.appendChild(alertDiv);
        }
        
        // Автоматически скрываем через 5 секунд
        setTimeout(() => {
            const bsAlert = new bootstrap.Alert(alertDiv);
            bsAlert.close();
        }, 5000);
    } else {
        // Fallback: используем alert браузера
        alert(message);
    }
}
</script>
{% endblock extra_js %}

