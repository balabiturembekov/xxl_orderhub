# üêõ –û—Ç—á–µ—Ç –æ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –±–∞–≥–∞—Ö –≤ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–µ (QA Analysis - –†–∞—É–Ω–¥ 9)

**–î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞:** 9 –¥–µ–∫–∞–±—Ä—è 2025  
**–ê–Ω–∞–ª–∏—Ç–∏–∫:** QA Engineer  
**–ú–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è:** –ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ –∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏

---

## üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢

### BUG-63: –û–±—Ö–æ–¥ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞ –≤ `_execute_send_order`

**–§–∞–π–ª:** `orders/views/confirmation_views.py:928`

**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
def _execute_send_order(confirmation: OrderConfirmation, user, comments: str) -> None:
    order = confirmation.order
    
    # Validate order status
    if order.status != 'uploaded':
        raise ValueError('–ó–∞–∫–∞–∑ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∏–ª–∏ –∏–º–µ–µ—Ç –¥—Ä—É–≥–æ–π —Å—Ç–∞—Ç—É—Å!')
    
    try:
        with transaction.atomic():
            # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞
            order.status = 'sent'  # ‚ö†Ô∏è –ü—Ä—è–º–æ–µ –ø—Ä–∏—Å–≤–∞–∏–≤–∞–Ω–∏–µ –≤–º–µ—Å—Ç–æ mark_as_sent()!
            order.sent_at = timezone.now()
            order.save()
```

**–û–ø–∏—Å–∞–Ω–∏–µ:**
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä—è–º–æ–µ –ø—Ä–∏—Å–≤–∞–∏–≤–∞–Ω–∏–µ `order.status = 'sent'` –≤–º–µ—Å—Ç–æ –º–µ—Ç–æ–¥–∞ `order.mark_as_sent()`. –≠—Ç–æ –æ–±—Ö–æ–¥–∏—Ç –≤–∞–ª–∏–¥–∞—Ü–∏—é —Å—Ç–∞—Ç—É—Å–∞, –∫–æ—Ç–æ—Ä–∞—è –µ—Å—Ç—å –≤ –º–µ—Ç–æ–¥–µ `mark_as_sent()`. –•–æ—Ç—è –µ—Å—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –ø—Ä–∏—Å–≤–∞–∏–≤–∞–Ω–∏–µ–º, –Ω–æ —ç—Ç–æ –Ω–µ –∞—Ç–æ–º–∞—Ä–Ω–æ –∏ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –ø—Ä–æ–±–ª–µ–º–∞–º –ø—Ä–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö.

**–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ:**
1. –î–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—Ç –æ—Ç–ø—Ä–∞–≤–∫—É –æ–¥–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞
2. –û–±–∞ –ø—Ä–æ—Ö–æ–¥—è—Ç –ø—Ä–æ–≤–µ—Ä–∫—É `if order.status != 'uploaded'`
3. –û–±–∞ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç `order.status = 'sent'`
4. –û–±–∞ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç –∑–∞–∫–∞–∑

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–µ—Ç–æ–¥ `mark_as_sent()`, –∫–æ—Ç–æ—Ä—ã–π –∏–º–µ–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—É—é –≤–∞–ª–∏–¥–∞—Ü–∏—é:
```python
# –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ —á–µ—Ä–µ–∑ –º–µ—Ç–æ–¥ —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
order.mark_as_sent()
```

---

### BUG-64: Race condition –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ E-Factura —Ñ–∞–π–ª–æ–≤ –≤ `upload_invoice_execute` –∏ `upload_invoice_with_payment`

**–§–∞–π–ª—ã:** 
- `orders/views/confirmation_views.py:488`
- `orders/views/payment_views.py:121`

**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω –ª–∏ —É–∂–µ —Ñ–∞–π–ª –¥–ª—è —ç—Ç–æ–≥–æ –∑–∞–∫–∞–∑–∞
existing_file = EFacturaFile.objects.filter(order=order).first()  # ‚ö†Ô∏è –ù–ï–¢ select_for_update()!
if not existing_file:
    # ... —Å–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ ...
    efactura_file.save()
```

**–û–ø–∏—Å–∞–Ω–∏–µ:**
–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –±–µ–∑ `select_for_update()`, —á—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ —Å–æ–∑–¥–∞–Ω–∏—é –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –ø—Ä–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–µ –∏–Ω–≤–æ–π—Å–æ–≤ –¥–ª—è –æ–¥–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞. –•–æ—Ç—è –µ—Å—Ç—å `unique_together = [['order', 'basket']]`, –Ω–æ —ç—Ç–æ –ø—Ä–∏–≤–µ–¥–µ—Ç –∫ `IntegrityError`, –∫–æ—Ç–æ—Ä—ã–π –Ω—É–∂–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å.

**–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ:**
1. –î–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –∑–∞–≥—Ä—É–∂–∞—é—Ç –∏–Ω–≤–æ–π—Å –¥–ª—è –æ–¥–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞ —Å `e_factura_turkey=True`
2. –û–±–∞ –ø—Ä–æ—Ö–æ–¥—è—Ç –ø—Ä–æ–≤–µ—Ä–∫—É `if not existing_file`
3. –û–±–∞ —Å–æ–∑–¥–∞—é—Ç `EFacturaFile` –¥–ª—è –æ–¥–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞
4. –û–¥–∏–Ω –ø–æ–ª—É—á–∞–µ—Ç `IntegrityError` –∏–∑-–∑–∞ `unique_together`

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `select_for_update()` –¥–ª—è –∞—Ç–æ–º–∞—Ä–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏:
```python
with transaction.atomic():
    # –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï BUG-64: –ò—Å–ø–æ–ª—å–∑—É–µ–º select_for_update() –¥–ª—è –∞—Ç–æ–º–∞—Ä–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
    existing_file = EFacturaFile.objects.select_for_update().filter(order=order).first()
    if not existing_file:
        # ... —Å–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ ...
        try:
            efactura_file.save()
        except IntegrityError:
            # –§–∞–π–ª –±—ã–ª —Å–æ–∑–¥–∞–Ω –¥—Ä—É–≥–∏–º –ø—Ä–æ—Ü–µ—Å—Å–æ–º –º–µ–∂–¥—É –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
            messages.warning(request, '–§–∞–π–ª E-Factura —É–∂–µ –±—ã–ª –¥–æ–±–∞–≤–ª–µ–Ω –¥—Ä—É–≥–∏–º –ø—Ä–æ—Ü–µ—Å—Å–æ–º.')
            return redirect('order_detail', pk=order.pk)
```

---

### BUG-65: Race condition –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ E-Factura —Ñ–∞–π–ª–æ–≤ –≤ `_execute_complete_order`

**–§–∞–π–ª:** `orders/views/confirmation_views.py:1005`

**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
# –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –≤–Ω—É—Ç—Ä–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
existing_file = EFacturaFile.objects.filter(order=order).first()  # ‚ö†Ô∏è –ù–ï–¢ select_for_update()!
if not existing_file and order.invoice_file:
    # ... —Å–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ ...
```

**–û–ø–∏—Å–∞–Ω–∏–µ:**
–ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ BUG-64, –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –±–µ–∑ `select_for_update()`, —á—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ —Å–æ–∑–¥–∞–Ω–∏—é –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –ø—Ä–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `select_for_update()`:
```python
# –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï BUG-65: –ò—Å–ø–æ–ª—å–∑—É–µ–º select_for_update() –¥–ª—è –∞—Ç–æ–º–∞—Ä–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
existing_file = EFacturaFile.objects.select_for_update().filter(order=order).first()
```

---

## üü† –í–´–°–û–ö–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢

### BUG-66: –ù–µ–ø–æ–ª–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è —Å—É–º–º—ã –ø–ª–∞—Ç–µ–∂–∞ –≤ `InvoiceWithPaymentForm.clean_payment_amount()`

**–§–∞–π–ª:** `orders/forms.py:767-784`

**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
def clean_payment_amount(self):
    """–í–∞–ª–∏–¥–∞—Ü–∏—è —Å—É–º–º—ã –ø–ª–∞—Ç–µ–∂–∞"""
    amount = self.cleaned_data.get('payment_amount')
    balance = self.cleaned_data.get('balance')
    
    if amount is None:
        return None
    
    if amount <= 0:
        raise forms.ValidationError("–°—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±–æ–ª—å—à–µ –Ω—É–ª—è.")
    
    if balance and amount and amount > balance:
        raise forms.ValidationError(
            f"–°—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞ ({amount}) –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–µ–≤—ã—à–∞—Ç—å –æ–±—â—É—é —Å—É–º–º—É –∏–Ω–≤–æ–π—Å–∞ ({balance})."
        )
    # ‚ö†Ô∏è –ù–ï–¢ –ü–†–û–í–ï–†–ö–ò remaining_amount –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∏–Ω–≤–æ–π—Å–æ–≤!
```

**–û–ø–∏—Å–∞–Ω–∏–µ:**
–ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ `amount > balance` (–æ–±—â–∞—è —Å—É–º–º–∞ –∏–Ω–≤–æ–π—Å–∞), –Ω–æ –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è `remaining_amount` –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∏–Ω–≤–æ–π—Å–æ–≤. –ï—Å–ª–∏ –∏–Ω–≤–æ–π—Å —É–∂–µ —á–∞—Å—Ç–∏—á–Ω–æ –æ–ø–ª–∞—á–µ–Ω, –º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –ø–ª–∞—Ç–µ–∂ –±–æ–ª—å—à–µ —á–µ–º `remaining_amount`, –Ω–æ –º–µ–Ω—å—à–µ —á–µ–º `balance`.

**–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ:**
1. –°–æ–∑–¥–∞—Ç—å –∏–Ω–≤–æ–π—Å —Å –±–∞–ª–∞–Ω—Å–æ–º 1000
2. –û–ø–ª–∞—Ç–∏—Ç—å 600 (–æ—Å—Ç–∞—Ç–æ–∫: 400)
3. –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞ —É–∫–∞–∑–∞—Ç—å `amount=500`, `balance=1000`
4. –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–æ–π–¥–µ—Ç (500 < 1000), –Ω–æ —ç—Ç–æ –±–æ–ª—å—à–µ –æ—Å—Ç–∞—Ç–∫–∞!

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
–ü—Ä–æ–≤–µ—Ä—è—Ç—å `remaining_amount` –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∏–Ω–≤–æ–π—Å–æ–≤:
```python
if balance and amount and amount > balance:
    raise forms.ValidationError(
        f"–°—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞ ({amount}) –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–µ–≤—ã—à–∞—Ç—å –æ–±—â—É—é —Å—É–º–º—É –∏–Ω–≤–æ–π—Å–∞ ({balance})."
    )

# –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï BUG-66: –ü—Ä–æ–≤–µ—Ä—è–µ–º remaining_amount –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∏–Ω–≤–æ–π—Å–æ–≤
if self.invoice and self.invoice.pk:
    self.invoice.refresh_from_db()
    remaining = self.invoice.remaining_amount
    if amount > remaining:
        raise forms.ValidationError(
            f"–°—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞ ({amount}) –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–µ–≤—ã—à–∞—Ç—å –æ—Å—Ç–∞—Ç–æ–∫ –∫ –¥–æ–ø–ª–∞—Ç–µ ({remaining})."
        )
```

---

### BUG-67: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞ –ø–µ—Ä–µ–¥ –ø—Ä—è–º—ã–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º —Å—Ç–∞—Ç—É—Å–∞

**–§–∞–π–ª:** `orders/views/confirmation_views.py:928`

**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
# Validate order status
if order.status != 'uploaded':
    raise ValueError('–ó–∞–∫–∞–∑ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∏–ª–∏ –∏–º–µ–µ—Ç –¥—Ä—É–≥–æ–π —Å—Ç–∞—Ç—É—Å!')

try:
    with transaction.atomic():
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞
        order.status = 'sent'  # ‚ö†Ô∏è –ü—Ä—è–º–æ–µ –ø—Ä–∏—Å–≤–∞–∏–≤–∞–Ω–∏–µ –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ—Å–ª–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏!
        order.sent_at = timezone.now()
        order.save()
```

**–û–ø–∏—Å–∞–Ω–∏–µ:**
–•–æ—Ç—è –µ—Å—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–µ—Ä–µ–¥ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–µ–π, –Ω–æ –ø–æ—Å–ª–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∑–∞–∫–∞–∑–∞ (`select_for_update()`) –Ω–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏. –ú–µ–∂–¥—É –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–æ–π —Å—Ç–∞—Ç—É—Å –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å—Å—è.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `select_for_update()` –∏ –ø–æ–≤—Ç–æ—Ä–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É:
```python
try:
    with transaction.atomic():
        # –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï BUG-67: –ë–ª–æ–∫–∏—Ä—É–µ–º –∑–∞–∫–∞–∑ –∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
        order = Order.objects.select_for_update().get(pk=order.pk)
        
        # –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ—Å–ª–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
        if order.status != 'uploaded':
            raise ValueError('–ó–∞–∫–∞–∑ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∏–ª–∏ –∏–º–µ–µ—Ç –¥—Ä—É–≥–æ–π —Å—Ç–∞—Ç—É—Å!')
        
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–µ—Ç–æ–¥ —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
        order.mark_as_sent()
```

---

## üü° –°–†–ï–î–ù–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢

### BUG-68: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ IntegrityError –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ E-Factura —Ñ–∞–π–ª–æ–≤

**–§–∞–π–ª—ã:**
- `orders/views/confirmation_views.py:488-520`
- `orders/views/payment_views.py:121-180`
- `orders/views/confirmation_views.py:1005-1080`

**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
existing_file = EFacturaFile.objects.filter(order=order).first()
if not existing_file:
    # ... —Å–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ ...
    efactura_file.save()  # ‚ö†Ô∏è –ú–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å IntegrityError, –Ω–æ –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è!
```

**–û–ø–∏—Å–∞–Ω–∏–µ:**
–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ `EFacturaFile` –º–æ–∂–µ—Ç –≤–æ–∑–Ω–∏–∫–Ω—É—Ç—å `IntegrityError` –∏–∑-–∑–∞ `unique_together = [['order', 'basket']]`, –Ω–æ –æ—à–∏–±–∫–∞ –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è. –≠—Ç–æ –ø—Ä–∏–≤–µ–¥–µ—Ç –∫ 500 –æ—à–∏–±–∫–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
–û–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å `IntegrityError`:
```python
from django.db import IntegrityError

try:
    efactura_file.save()
except IntegrityError:
    # –§–∞–π–ª –±—ã–ª —Å–æ–∑–¥–∞–Ω –¥—Ä—É–≥–∏–º –ø—Ä–æ—Ü–µ—Å—Å–æ–º –º–µ–∂–¥—É –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
    import logging
    logger = logging.getLogger('orders')
    logger.warning(f'–ü–æ–ø—ã—Ç–∫–∞ —Å–æ–∑–¥–∞—Ç—å –¥—É–±–ª–∏–∫–∞—Ç E-Factura —Ñ–∞–π–ª–∞ –¥–ª—è –∑–∞–∫–∞–∑–∞ {order.id}')
    messages.warning(request, '–§–∞–π–ª E-Factura —É–∂–µ –±—ã–ª –¥–æ–±–∞–≤–ª–µ–Ω –¥—Ä—É–≥–∏–º –ø—Ä–æ—Ü–µ—Å—Å–æ–º.')
```

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –†–∞—É–Ω–¥–∞ 9

- **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –±–∞–≥–æ–≤:** 3 (–æ–±—Ö–æ–¥ –≤–∞–ª–∏–¥–∞—Ü–∏–∏, race conditions)
- **–í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** 2 (–≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–ª–∞—Ç–µ–∂–µ–π, –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞)
- **–°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** 1 (–æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫)
- **–í—Å–µ–≥–æ –Ω–∞–π–¥–µ–Ω–æ –±–∞–≥–æ–≤:** 6

---

## ‚úÖ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1 (–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π):
1. ‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ–±—Ö–æ–¥ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –≤ `_execute_send_order` - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `mark_as_sent()`
2. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å `select_for_update()` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ E-Factura —Ñ–∞–π–ª–æ–≤
3. ‚úÖ –û–±—Ä–∞–±–æ—Ç–∞—Ç—å `IntegrityError` –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ E-Factura —Ñ–∞–π–ª–æ–≤

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2 (–í—ã—Å–æ–∫–∏–π):
4. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É `remaining_amount` –≤ `InvoiceWithPaymentForm.clean_payment_amount()`
5. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É —Å—Ç–∞—Ç—É—Å–∞ –ø–æ—Å–ª–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∑–∞–∫–∞–∑–∞

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3 (–°—Ä–µ–¥–Ω–∏–π):
6. ‚úÖ –û–±—Ä–∞–±–æ—Ç–∞—Ç—å `IntegrityError` –≤–æ –≤—Å–µ—Ö –º–µ—Å—Ç–∞—Ö —Å–æ–∑–¥–∞–Ω–∏—è E-Factura —Ñ–∞–π–ª–æ–≤

---

## üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

- –í—Å–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –±–∞–≥–∏ —Å–≤—è–∑–∞–Ω—ã —Å –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–æ–π –∏ –º–æ–≥—É—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é –¥–∞–Ω–Ω—ã—Ö
- Race conditions –º–æ–≥—É—Ç –±—ã—Ç—å –ø—Ä–æ–±–ª–µ–º–æ–π –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ
- –û–±—Ö–æ–¥ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –Ω–∞—Ä—É—à–µ–Ω–∏—é workflow –∑–∞–∫–∞–∑–æ–≤

